# Escape Codes and Standards

## What Are Escape Codes?

Escape codes are invisible character sequences that control terminals. They start with ESC (ASCII 27, written as `\x1b`, `\033`, or `\e`).

**Two types**:
1. **Input codes**: Generated by keypresses (arrow keys, function keys)
2. **Output codes**: Your program uses to control display (colors, cursor movement)

## Output Escape Code Standards

### ECMA-48 Foundation

The base standard defining escape code formats:

**CSI (Control Sequence Introducer)**: `ESC [` followed by parameters
```
ESC[2J        # Clear screen
ESC[H         # Move cursor to home
ESC[1;31m     # Red foreground color
```

**OSC (Operating System Command)**: `ESC ]` followed by parameters
```
ESC]0;Title\x07    # Set window title
ESC]52;c;base64\x07   # Clipboard access (OSC 52)
```

### XTerm Extensions

XTerm added features beyond ECMA-48:
- Mouse reporting (click, drag, scroll)
- Clipboard access via OSC 52
- Extended color modes (256 colors, RGB)

**These aren't formally standardized** but are widely supported because xterm is so influential.

### Terminfo Database

A database mapping terminal types to their capabilities:

```bash
echo $TERM              # xterm-256color, screen-256color, etc.
infocmp $TERM           # Dump terminal capabilities
tput bold               # Output "bold" escape sequence for $TERM
```

**Terminfo Approach**:
1. Query terminfo for escape sequences
2. Adapts to different terminals automatically
3. Complex to use, slower

**Hardcoded Approach**:
1. Use common escape sequences directly
2. Test across major terminals
3. Simpler, faster, good enough for most

**Most modern programs use the hardcoded approach** for the subset of widely-supported sequences.

## Practical Compatibility Strategies

**Strategy 1**: Stick to well-supported sequences
- 16 ANSI colors (ESC[30-37m, ESC[40-47m)
- Basic cursor movement (ESC[H, ESC[A/B/C/D)
- Clear screen/line (ESC[2J, ESC[K)

**Strategy 2**: Test on major terminal emulators
- iTerm2, Alacritty (macOS)
- GNOME Terminal, Konsole (Linux)
- Windows Terminal (Windows)
- tmux and screen (multiplexers)

**Strategy 3**: Provide fallbacks
```
if supports_256_colors():
    use_256_color_palette()
elif supports_16_colors():
    use_basic_colors()
else:
    no_colors()
```

**Examples from Proven Programs**:
- **less**: Queries terminfo, falls back to hardcoded
- **vim**: Extensive terminfo support with fallbacks
- **ripgrep**: Hardcoded ANSI, works everywhere

### When to Use Libraries vs Raw Escape Codes

**Use Libraries When**:
- Building complex TUIs (ncurses, crossterm, etc.)
- Need mouse support
- Want automatic capability detection
- Cross-platform support (Windows Console API)

**Use Raw Escape Codes When**:
- Simple color output
- Progress bars
- Cursor positioning for simple UIs
- You want minimal dependencies

## Input Escape Sequences

### Arrow Keys and Function Keys

When users press special keys, terminals send multi-character escape sequences:

| Key | Sequence | Notes |
|-----|----------|-------|
| Up | `ESC[A` | CSI sequence |
| Down | `ESC[B` | |
| Right | `ESC[C` | |
| Left | `ESC[D` | |
| Home | `ESC[H` or `ESC[1~` | Varies by terminal |
| End | `ESC[F` or `ESC[4~` | |
| Page Up | `ESC[5~` | |
| Page Down | `ESC[6~` | |
| F1 | `ESC OP` or `ESC[[A` | Highly variable |
| F12 | `ESC[24~` | |

### Distinguishing ESC Key from Escape Sequences

**The Problem**: ESC character can mean:
1. User pressed ESC key (standalone)
2. Start of escape sequence (ESC[A for up arrow)

**Solution**: Timeout-based parsing
```
Read character:
    If ESC:
        Wait ~50ms for next character:
            If timeout: User pressed ESC
            Else: Start of sequence, continue reading
```

**Proven Programs**:
- **vim**: Uses 1 second timeout (customizable with `ttimeoutlen`)
- **less**: Uses short timeout
- **readline**: Configurable timeout

### Mouse Events

Modern terminals can send mouse events (clicks, drags, scrolls):

```
ESC[<0;10;5M    # Mouse button press at column 10, row 5
```

**Enable mouse reporting**:
```
ESC[?1000h      # Send button press/release
ESC[?1002h      # Send button press/release/drag
ESC[?1006h      # SGR mouse mode (better format)
```

**Disable when exiting**:
```
ESC[?1000l
```

**Used by**: vim, tmux, less, htop

## ANSI Escape Sequence Reference

### CSI Sequences (Control Sequence Introducer)

**Format**: `ESC [ <parameters> <command>`

**Cursor Movement**:
```
ESC[H        # Move to home (1,1)
ESC[<r>;<c>H # Move to row r, column c
ESC[<n>A     # Move up n lines
ESC[<n>B     # Move down n lines
ESC[<n>C     # Move right n columns
ESC[<n>D     # Move left n columns
ESC[<n>E     # Move to beginning of line n lines down
ESC[<n>F     # Move to beginning of line n lines up
ESC[<n>G     # Move to column n
ESC[6n       # Query cursor position (response: ESC[<r>;<c>R)
```

**Erasing**:
```
ESC[J        # Clear from cursor to end of screen
ESC[1J       # Clear from cursor to beginning of screen
ESC[2J       # Clear entire screen
ESC[K        # Clear from cursor to end of line
ESC[1K       # Clear from cursor to beginning of line
ESC[2K       # Clear entire line
```

**Scrolling**:
```
ESC[<n>S     # Scroll up n lines
ESC[<n>T     # Scroll down n lines
```

**SGR (Select Graphic Rendition)** - Colors and Styles:
```
ESC[0m       # Reset all attributes
ESC[1m       # Bold
ESC[2m       # Dim
ESC[3m       # Italic
ESC[4m       # Underline
ESC[5m       # Blinking
ESC[7m       # Reverse video
ESC[8m       # Hidden
ESC[9m       # Strikethrough

# Foreground colors (30-37, 90-97)
ESC[30m      # Black
ESC[31m      # Red
ESC[32m      # Green
ESC[33m      # Yellow
ESC[34m      # Blue
ESC[35m      # Magenta
ESC[36m      # Cyan
ESC[37m      # White
ESC[90-97m   # Bright colors

# Background colors (40-47, 100-107)
ESC[40m      # Black background
ESC[41m      # Red background
...

# 256 colors
ESC[38;5;<n>m   # Foreground (n = 0-255)
ESC[48;5;<n>m   # Background

# RGB colors
ESC[38;2;<r>;<g>;<b>m   # Foreground
ESC[48;2;<r>;<g>;<b>m   # Background
```

### OSC Sequences (Operating System Command)

**Format**: `ESC ] <command> ; <parameters> BEL` or `ESC ] <command> ; <parameters> ESC \`

**Common Uses**:
```
ESC]0;Title\x07          # Set window title
ESC]1;Icon Name\x07      # Set icon name
ESC]2;Window Title\x07   # Set window title (same as 0)

# OSC 52 - Clipboard
ESC]52;c;<base64>\x07    # Copy to clipboard
ESC]52;c;?\x07           # Query clipboard
```

### Private Sequences

**Format**: `ESC [ ? <n> h` (set) or `ESC [ ? <n> l` (reset)

**Common Uses**:
```
ESC[?25h     # Show cursor
ESC[?25l     # Hide cursor
ESC[?1049h   # Use alternate screen buffer
ESC[?1049l   # Use main screen buffer
ESC[?1000h   # Enable mouse button tracking
ESC[?1002h   # Enable mouse button and drag tracking
ESC[?1006h   # Enable SGR mouse mode
```

## Terminal Capabilities

### Terminfo Concepts

**Purpose**: Database of terminal capabilities

**Structure**:
```
Terminal Type (from $TERM)
  ├─ Boolean Capabilities (am, xenl, etc.)
  ├─ Numeric Capabilities (cols, lines, colors)
  └─ String Capabilities (cup, clear, bold, etc.)
```

**Querying Terminfo**:
```bash
# Show all capabilities for current terminal
infocmp

# Show specific capability
tput bold        # Output escape sequence for bold
tput colors      # Output number of colors
tput cols        # Output terminal width
```

**Using in Code** (C):
```c
#include <term.h>
#include <curses.h>

setupterm(NULL, STDOUT_FILENO, NULL);

char *clear_screen = tigetstr("clear");
char *bold = tigetstr("bold");

printf("%s", clear_screen);  // Clear screen
printf("%sHello%s", bold, tparm(tigetstr("sgr0")));  // Bold text
```

### Capability Detection Patterns

**Pattern 1**: Try and fallback
```
try:
    output(complex_escape_sequence)
    query_terminal_response()
    if response == expected:
        terminal_supports_feature = true
timeout:
    terminal_supports_feature = false
```

**Pattern 2**: Check $TERM
```
if "256color" in $TERM:
    use_256_colors = true

if $TERM in ["dumb", "unknown"]:
    disable_all_formatting = true
```

**Pattern 3**: Check $COLORTERM
```
if $COLORTERM in ["truecolor", "24bit"]:
    use_rgb_colors = true
```
