#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = []
# ///

from __future__ import annotations

import os
import random
import subprocess
import sys
from pathlib import Path
from typing import Optional

# Configuration constants
WORKTREE_BASE = Path.home() / "git" / "worktrees"
ZELLIJ_SESSION = "claude"
BRANCH_PREFIX = "jshepherd"
MAX_COLLISION_ATTEMPTS = 10


def check_prerequisites() -> None:
    """Check that required commands are available."""
    for cmd in ["git", "zellij"]:
        result = subprocess.run(
            ["which", cmd], capture_output=True, text=True
        )
        if result.returncode != 0:
            print(f"Error: '{cmd}' command not found in PATH", file=sys.stderr)
            sys.exit(1)


def check_git_repository() -> bool:
    """Check if current directory is within a git repository."""
    result = subprocess.run(
        ["git", "rev-parse", "--git-dir"],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )
    return result.returncode == 0


def sanitize_name(name: str) -> str:
    """Sanitize name by replacing spaces with hyphens."""
    return name.replace(" ", "-")


def generate_random_digits() -> str:
    """Generate 6 random digits."""
    return f"{random.randint(0, 999999):06d}"


def branch_exists(branch_name: str) -> bool:
    """Check if a local branch exists."""
    result = subprocess.run(
        ["git", "show-ref", "--verify", "--quiet", f"refs/heads/{branch_name}"],
        capture_output=True,
    )
    return result.returncode == 0


def get_worktree_path(branch_name: str) -> Optional[Path]:
    """Get the worktree path for a branch if it exists."""
    result = subprocess.run(
        ["git", "worktree", "list", "--porcelain"],
        capture_output=True,
        text=True,
        check=True,
    )

    # Parse porcelain output
    # Format: worktree <path>\nHEAD <sha>\nbranch <ref>\n\n
    worktrees = result.stdout.strip().split("\n\n")

    for worktree_block in worktrees:
        lines = worktree_block.strip().split("\n")
        wt_path = None
        wt_branch = None

        for line in lines:
            if line.startswith("worktree "):
                wt_path = line[9:]  # Skip "worktree "
            elif line.startswith("branch "):
                wt_branch = line[7:]  # Skip "branch "

        if wt_branch == f"refs/heads/{branch_name}" and wt_path:
            return Path(wt_path)

    return None


def create_worktree(branch_name: str, path: Path, new_branch: bool) -> None:
    """Create a git worktree."""
    try:
        # Ensure parent directory exists
        path.parent.mkdir(parents=True, exist_ok=True)

        if new_branch:
            # Create new branch and worktree
            subprocess.run(
                ["git", "worktree", "add", "-b", branch_name, str(path)],
                check=True,
                capture_output=True,
                text=True,
            )
            print(f"Created new worktree: {path}")
        else:
            # Create worktree from existing branch
            subprocess.run(
                ["git", "worktree", "add", str(path), branch_name],
                check=True,
                capture_output=True,
                text=True,
            )
            print(f"Created worktree from existing branch: {path}")
    except subprocess.CalledProcessError as e:
        print(f"Error creating worktree: {e.stderr}", file=sys.stderr)
        sys.exit(1)


def ensure_zellij_session() -> None:
    """Ensure the Zellij session exists (create in background if needed)."""
    try:
        subprocess.run(
            ["zellij", "attach", "-c", ZELLIJ_SESSION, "--create-background"],
            check=True,
            capture_output=True,
            text=True,
        )
    except subprocess.CalledProcessError as e:
        # Ignore error if session already exists
        if "already exists" not in e.stderr.lower():
            print(f"Error creating Zellij session: {e.stderr}", file=sys.stderr)
            sys.exit(1)


def create_zellij_pane(pane_name: str, worktree_path: Path) -> None:
    """Create a new Zellij pane with the given name and working directory."""
    try:
        subprocess.run(
            [
                "zellij",
                "-s",
                ZELLIJ_SESSION,
                "action",
                "new-pane",
                "--name",
                pane_name,
                "--cwd",
                str(worktree_path),
                "--",
                "claude",
            ],
            check=True,
            capture_output=True,
            text=True,
        )
        print(f"Created pane '{pane_name}' in session '{ZELLIJ_SESSION}'")
    except subprocess.CalledProcessError as e:
        print(f"Error creating Zellij pane: {e.stderr}", file=sys.stderr)
        sys.exit(1)


def attach_to_zellij() -> None:
    """Attach to the Zellij session (replaces current process)."""
    os.execvp("zellij", ["zellij", "attach", ZELLIJ_SESSION])


def main() -> int:
    """Main function."""
    # Check arguments
    if len(sys.argv) != 2:
        print("Usage: claude-worktree <name>", file=sys.stderr)
        return 1

    name = sys.argv[1]

    # Check prerequisites
    check_prerequisites()

    if not check_git_repository():
        print("Error: Must be run from within a git repository", file=sys.stderr)
        return 1

    # Sanitize name
    sanitized_name = sanitize_name(name)

    # Try to generate unique branch name (with collision retry)
    branch_name = None
    worktree_path = None

    for attempt in range(MAX_COLLISION_ATTEMPTS):
        digits = generate_random_digits()
        candidate_branch = f"{BRANCH_PREFIX}/{sanitized_name}-{digits}"
        candidate_path = WORKTREE_BASE / f"{sanitized_name}-{digits}"
        pane_name = f"{sanitized_name}-{digits}"

        # Check if branch exists
        if branch_exists(candidate_branch):
            # Branch exists - check if worktree exists
            existing_worktree = get_worktree_path(candidate_branch)

            if existing_worktree:
                # Reuse existing worktree
                print(f"Reusing existing worktree: {existing_worktree}")
                worktree_path = existing_worktree
                branch_name = candidate_branch
                break
            else:
                # Branch exists but no worktree - create worktree from existing branch
                create_worktree(candidate_branch, candidate_path, new_branch=False)
                worktree_path = candidate_path
                branch_name = candidate_branch
                break
        else:
            # Branch doesn't exist - create new branch and worktree
            create_worktree(candidate_branch, candidate_path, new_branch=True)
            worktree_path = candidate_path
            branch_name = candidate_branch
            break

    if branch_name is None or worktree_path is None:
        print(
            f"Error: Failed to create unique branch after {MAX_COLLISION_ATTEMPTS} attempts",
            file=sys.stderr,
        )
        return 1

    # Ensure Zellij session exists
    ensure_zellij_session()

    # Create pane with claude command
    create_zellij_pane(pane_name, worktree_path)

    # Attach to session (replaces current process)
    attach_to_zellij()

    # This line is never reached due to execvp
    return 0


if __name__ == "__main__":
    sys.exit(main())
