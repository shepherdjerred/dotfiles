#!/bin/bash

{{ if eq .chezmoi.os "linux" -}}
# TODO: use appropriate command
sudo yum update; true
sudo apt update; sudo apt upgrade; true
{{ end -}}

brew update; brew upgrade
{{ with $brewfile := get .brewfile .chezmoi.hostname -}}
brew bundle install --file ~/.local/share/chezmoi/dot_homebrew/{{$brewfile}}
rm ~/.local/share/chezmoi/dot_homebrew/{{$brewfile}}
brew bundle dump --file ~/.local/share/chezmoi/dot_homebrew/{{$brewfile}}
{{ end -}}

vim +PlugUpdate +qall

{{ with $languages := get .languages .chezmoi.hostname -}}
{{ if hasKey $languages "rust" -}}
rustup update
{{ end -}}
{{ if hasKey $languages "python" -}}
pip install --upgrade pip
{{ end -}}
{{ if hasKey $languages "nodejs" -}}
npm update; npm upgrade
npm install -g npm
rm -v ~/package-lock.json
{{ end -}}
{{ end -}}

asdf plugin update --all
asdf install

{{ if eq .chezmoi.os "darwin" -}}
# stop, and upgrade yabai
brew services stop yabai
# brew upgrade yabai

# uninstall the scripting addition
sudo yabai --uninstall-sa

# installing the scripting addition will restart Dock.app
sudo yabai --install-sa

# finally, start yabai
brew services start yabai

killall Dock
{{ end }}
